---
layout: base
schema: BlogPosting
---

<div class="region" style="--region-space-top: var(--space-xl-2xl)">
  <div class="wrapper flow prose">
    <h1 class="gradient-text">{{ title }}</h1>

    {% if image %}
      <!-- image -->
      {% image image, alt or "", credit, "eager", "feature" %}
    {% endif %}
    
    <p class="meta | cluster gutter-xs-s">
      <!-- draft status -->
      {%- if draft -%}
        <span class="button" data-small-button data-button-variant="tertiary">draft</span>
      {%- endif %}
      <!-- date -->
      {% set definedDate = date %} {% include "partials/date.njk" %}
      {%
        if tags.length >
        1
      %}
        <!-- tags -->
        {% for tag in tags %}{% if tag != "posts" %}
          <a class="button" href="/tags/{{ tag | slugify }}/" data-small-button> {{ tag }} </a>
        {% endif %}{% endfor %}
      {% endif %}
    </p>
    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
      <label class="switch">
        <input type="checkbox" id="ai-toggle">
        <span class="slider round"></span>
      </label>
      <span style="user-select: none;">Enable AI Animation</span>
    </div>
    <div id="squirm-content">
      {{ content | safe }}
    </div>
    {% include 'partials/edit-on.njk' %}
  </div>

  <!--  h-card infos: https://indieweb.org/authorship -->
  <div hidden class="h-entry">
    <a class="u-url" href="{{ page.url | url | absoluteUrl(meta.url) }}">{{ title }}</a>
    <a class="p-name u-url" rel="author" href="{{ meta.url }}">{{ meta.author.name }}</a>
    <img
      eleventy:ignore
      class="u-author h-card"
      src="{{ meta.author.avatar | url | absoluteUrl(meta.url) }}"
      alt="{{ meta.author.name }}"
    />
  </div>
</div>

{%- css "local" -%}
  {%- include 'css/post.css' -%}
  {%- include 'css/footnotes.css' -%}
{%- endcss -%}

<script>
  document.getElementById('ai-toggle').addEventListener('change', function(e) {
    const container = document.getElementById("squirm-content");
    toggleSquirm(e.target.checked, container);
  });

  function toggleSquirm(shouldSquirm, container) {
    if (shouldSquirm) {
      if (!document.querySelector('script[src*="squirminal.js"]')) {
        const script = document.createElement('script');
        script.src = "https://unpkg.com/@zachleat/squirminal@3.0.1/squirminal.js";
        script.integrity = "sha384-m+pplzdzdfZuwjyxmM9pOkp/ALfMMjZll/b2g2mR6mhurvj1ZZAe8xXNj7BSp4XM";
        script.crossOrigin = "anonymous";
        script.onload = () => applySquirm(container);
        document.head.appendChild(script);
      } else {
        applySquirm(container);
      }
    } else {
      removeSquirm(container);
    }
  }

  function applySquirm(container) {
    if (container.querySelector('squirm-inal')) return;
    
    let squirm = document.createElement("squirm-inal");
    squirm.setAttribute("speed", "0.3");
    squirm.setAttribute("autoplay", "");
    
    const children = Array.from(container.children);
    squirm.append(...children);
    container.append(squirm);
  }

  function removeSquirm(container) {
    const squirm = container.querySelector('squirm-inal');
    if (squirm) {
      const children = Array.from(squirm.children);
      container.append(...children);
      squirm.remove();
    }
  }

  // Check for GET parameter
  const urlParams = new URLSearchParams(window.location.search);
  const aiParam = urlParams.get('ai');
  const aiToggle = document.getElementById('ai-toggle');
  
  if (aiParam === 'true') {
    aiToggle.checked = true;
    toggleSquirm(true, document.getElementById("squirm-content"));
    updateLinks(true);
  }

  // Update URL and Links on manual toggle
  aiToggle.addEventListener('change', (e) => {
    const isChecked = e.target.checked;
    const url = new URL(window.location);
    if (isChecked) {
        url.searchParams.set('ai', 'true');
    } else {
        url.searchParams.delete('ai');
    }
    window.history.replaceState({}, '', url);
    updateLinks(isChecked);
  });

  function updateLinks(isChecked) {
    document.querySelectorAll('a').forEach(link => {
        try {
            const linkUrl = new URL(link.href, window.location.origin);
            if (linkUrl.origin === window.location.origin) {
                if (isChecked) {
                    linkUrl.searchParams.set('ai', 'true');
                } else {
                    linkUrl.searchParams.delete('ai');
                }
                link.href = linkUrl.toString();
            }
        } catch (e) {
            // ignore invalid urls
        }
    });
  }
</script>
