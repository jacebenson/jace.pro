---
title: "Example of events stacked that send the same message"
date: 2015-11-23T23:33:56.000Z
authors: ["jonnyseymour"]
link: "https://community.servicenow.com/community?id=community_blog&sys_id=938d2a69dbd0dbc01dcaf3231f96195c"
---
<p>The notification from the ServiceNow UI can be extremely flexible with configuration. With all of the configuration capabilities and platform flexibilities for creating email notifications, you can end up overlooking how complex notifications can be. <a title="ki.servicenow.com/index.php?title=Email_Notifications#Creating_Email_Notifications" href="http://wiki.servicenow.com/index.php?title=Email_Notifications#Creating_Email_Notifications">Notifications are created </a>with a purpose to "<a title="ki.servicenow.com/index.php?title=Events_and_Email_Notification#gsc.tab=0" href="http://wiki.servicenow.com/index.php?title=Events_and_Email_Notification#gsc.tab=0">inform about an event</a>" and they are happily self-contained to integrate with the systems. However, this independence and simplicity can cause oversight on them triggering the same message.</p><p></p><p><img  alt="949.1662-Spam1.jpg" class="image-10 jive-image" height="94" src="91322d06db5c130468c1fb651f961990.iix" style="width: 272px; height: 93.8839px; display: block; margin-left: auto; margin-right: auto;" width="272"/></p><p></p><p>Lets talk about</p><ul><li>The problem with events stacked that send the same notification</li><li>Example of events stacked sending the same notification message</li><li>Using event parm1 values to overcome events sending the same notification message</li><li>Using the notification weight to overcome duplicated email</li></ul><p></p><p>Most events are not processed straight away. Events will queue up and they have to hold until previous events are processed. Once the previous events are processed, then the following events can fire. The <a title="ki.servicenow.com/index.php?title=Events_and_Email_Notification#gsc.tab=0" href="http://wiki.servicenow.com/index.php?title=Events_and_Email_Notification#gsc.tab=0" style="line-height: 1.5;">sysevent table</a><span style="line-height: 1.5;"> holds the event queue generated by the system. </span></p><p></p><p>Events allow you to specify:</p><ul><li>Event name</li><li>Target record</li><li>Two parameters</li></ul><p></p><p>They have four states:</p><ul><li>Ready</li><li>Processed</li><li>Error</li><li>Transferred</li></ul><p></p><p><a title="ki.servicenow.com/index.php?title=Events_and_Email_Notification#gsc.tab=0" href="http://wiki.servicenow.com/index.php?title=Events_and_Email_Notification#gsc.tab=0">Events </a>named 'notification_engine.process' are Engine based. Any other event, not named 'notification_engine.process' is considered Event based. A simplified version to explain the event life cycle looks like this:</p><p></p><table border="1" cellpadding="0" cellspacing="0" height="343" style="border: 1pt solid windowtext; padding: 0px 5.4pt; height: 314px; width: 708px;" width="707"><tbody><tr><td style="border: solid windowtext 1.0pt; background: #FFC000; padding: 0 5.4pt 0 5.4pt;" width="149"><p><strong>Delay</strong></p></td><td style="border: solid windowtext 1.0pt; background: #FFC000; padding: 0 5.4pt 0 5.4pt;" width="262"><p><strong>Event cycle</strong></p></td><td style="border: solid windowtext 1.0pt; background: #FFC000; padding: 0 5.4pt 0 5.4pt;" width="205"><p><strong>Data changes</strong></p></td></tr><tr><td style="border: solid windowtext 1.0pt; padding: 0 5.4pt 0 5.4pt;" width="149"></td><td style="border: solid windowtext 1.0pt; background: #E2EFD9; padding: 0 5.4pt 0 5.4pt;" width="262"><p>Events are created in "Ready" state</p></td><td style="border: solid windowtext 1.0pt; padding: 0 5.4pt 0 5.4pt;" width="205"><p>Record expected by event is accurate</p></td></tr><tr><td style="border: solid windowtext 1.0pt; background: #FFA591; padding: 0 5.4pt 0 5.4pt;" width="149"><p>#1 Event is queued — this is the most likely delay</p></td><td style="border: solid windowtext 1.0pt; padding: 0 5.4pt 0 5.4pt;" width="262"><p>Events WAIT - this could be seconds, or minutes if there are previous events or the event processor is stopped, etc</p></td><td style="border: solid windowtext 1.0pt; padding: 0 5.4pt 0 5.4pt;" width="205"><p>Users or workflow may change the record</p></td></tr><tr><td style="border: solid windowtext 1.0pt; padding: 0 5.4pt 0 5.4pt;" width="149"><p>Processing start</p></td><td style="border: solid windowtext 1.0pt; background: #E2EFD9; padding: 0 5.4pt 0 5.4pt;" width="262"><p>Events are 'claimed' by a node, then set to "processed" state when completed</p><p>If they trigger <a href="http://wiki.servicenow.com/index.php?title=Events_and_Email_Notification#gsc.tab=0"><span style="color: windowtext;">email notifications</span></a>, the conditions are evaluated here with the 'current' record*</p></td><td style="border: solid windowtext 1.0pt; background: #FFA591; padding: 0 5.4pt 0 5.4pt;" width="205"><p>*Record can have changed by this time</p></td></tr><tr><td style="border: solid windowtext 1.0pt; background: #FFA591; padding: 0 5.4pt 0 5.4pt;" width="149"><p>#2 Delay depends on the number of recipients</p></td><td style="border: solid windowtext 1.0pt; padding: 0 5.4pt 0 5.4pt;" width="262"><p>Then <a href="http://wiki.servicenow.com/index.php?title=Events_and_Email_Notification#gsc.tab=0"><span style="color: windowtext;">email notification</span></a> is processed to generate the recipients</p></td><td style="border: solid windowtext 1.0pt; padding: 0 5.4pt 0 5.4pt;" width="205"><p>Users or workflow may change the record</p></td></tr><tr><td style="border: solid windowtext 1.0pt; padding: 0 5.4pt 0 5.4pt;" width="149"></td><td style="border: solid windowtext 1.0pt; padding: 0 5.4pt 0 5.4pt;" width="262"><p>Then generate the notification message with the 'current' record**</p></td><td style="border: solid windowtext 1.0pt; background: #FFA591; padding: 0 5.4pt 0 5.4pt;" width="205"><p>**Record can have changed again by it is less likely</p></td></tr><tr><td style="border: solid windowtext 1.0pt; padding: 0 5.4pt 0 5.4pt;" width="149"><p>Processing ends</p></td><td style="border: solid windowtext 1.0pt; background: #E2EFD9; padding: 0 5.4pt 0 5.4pt;" width="262"><p>Processed time is set</p></td></tr></tbody></table><p></p><p></p><p>The <a title="ki.servicenow.com/index.php?title=Events_and_Email_Notification#gsc.tab=0" href="http://wiki.servicenow.com/index.php?title=Events_and_Email_Notification#gsc.tab=0">Event</a> Processor in the ServiceNow system is in charge of handling the events that come in. Think of it as the swiss army knife of the notification system. Being that the Event Processor has several actions to review, manage and fire, like any assembly line, if it gets too backed up it could cause performance issues. If the event processor is stopped, or busy, it can cause a long queue list of <a title="ki.servicenow.com/index.php?title=Events_and_Email_Notification#gsc.tab=0" href="http://wiki.servicenow.com/index.php?title=Events_and_Email_Notification#gsc.tab=0">events</a>. As default, every 30 seconds gs.eventsProcess() runs on each node and clears the 'ready' events.</p><pre __default_attr="info" __jive_macro_name="alert" alert="info" class="jive_text_macro jive_macro_alert" data-renderedposition="1280.0833740234375_8_917_64"><p>You recognise this problem because the notification usually has a conditions with data is likely to change (e.g. conditions on assigned group, assigned to, etc.) and it's usually the source of the triggering event itself (e.g. incident.assigned)</p></pre><p>The source of the problem with events stacked that send the same notification is that there is a delay between event creation and the event being processed. There is a tiny chance of delay on recipient creation. By the time the <a title="ki.servicenow.com/index.php?title=Events_and_Email_Notification#gsc.tab=0" href="http://wiki.servicenow.com/index.php?title=Events_and_Email_Notification#gsc.tab=0">notification conditions are processed</a> there is a chance the current record could have changed. The problem here is that an event that should have not passed the conditions, will later pass them because the new values passes the notification conditions. In most cases the result is the same message send twice.</p><p></p><h2>Here is an example of events stacked sending the same notification message:</h2><p>To better articulate why duplicate notifications due the event stacked is an issue, and passing outdated records through validation is bad, I have put together an example.</p><p></p><p>I have set three(3) users:</p><ol><li>Alejandra Prenatt - Sysid = 22826bf03710200044e0bfc8bcbe5dec</li><li>David Loo</li><li>Charles Tylor (Duty Manager).</li></ol><p></p><p>I created a test<a title="ki.servicenow.com/index.php?title=Events_and_Email_Notification#gsc.tab=0" href="http://wiki.servicenow.com/index.php?title=Events_and_Email_Notification#gsc.tab=0"> notification</a> that should only fire with assigned to is "Alejandra Prenatt":</p><p></p><table border="1" cellpadding="0" cellspacing="0" height="190" style="padding: 0px 5.4pt; height: 191px; width: 576px;"><tbody><tr><td style="border: solid windowtext 1.0pt; padding: 0 5.4pt 0 5.4pt;" valign="top" width="66"><p>Name</p></td><td style="border: solid windowtext 1.0pt; border-left: none; padding: 0 5.4pt 0 5.4pt;" valign="top" width="16"><p>=</p></td><td style="border: solid windowtext 1.0pt; border-left: none; padding: 0 5.4pt 0 5.4pt;" valign="top" width="288"><p>test_notification_01</p></td></tr><tr><td style="border: solid windowtext 1.0pt; border-top: none; padding: 0 5.4pt 0 5.4pt;" valign="top" width="66"><p>Table</p></td><td style="border-top: none; border-left: none; border-bottom: solid windowtext 1.0pt; border-right: solid windowtext 1.0pt; padding: 0 5.4pt 0 5.4pt;" valign="top" width="16"><p>=</p></td><td style="border-top: none; border-left: none; border-bottom: solid windowtext 1.0pt; border-right: solid windowtext 1.0pt; padding: 0 5.4pt 0 5.4pt;" valign="top" width="288"><p>Incident</p></td></tr><tr><td style="border: solid windowtext 1.0pt; border-top: none; padding: 0 5.4pt 0 5.4pt;" valign="top" width="66"><p>Event name</p></td><td style="border-top: none; border-left: none; border-bottom: solid windowtext 1.0pt; border-right: solid windowtext 1.0pt; padding: 0 5.4pt 0 5.4pt;" valign="top" width="16"><p>=</p></td><td style="border-top: none; border-left: none; border-bottom: solid windowtext 1.0pt; border-right: solid windowtext 1.0pt; padding: 0 5.4pt 0 5.4pt;" valign="top" width="288"><p>incident.assigned</p></td></tr><tr><td style="border: solid windowtext 1.0pt; border-top: none; padding: 0 5.4pt 0 5.4pt;" valign="top" width="66"><p>Condition</p></td><td style="border-top: none; border-left: none; border-bottom: solid windowtext 1.0pt; border-right: solid windowtext 1.0pt; padding: 0 5.4pt 0 5.4pt;" valign="top" width="16"><p>=</p></td><td style="border-top: none; border-left: none; border-bottom: solid windowtext 1.0pt; border-right: solid windowtext 1.0pt; padding: 0 5.4pt 0 5.4pt;" valign="top" width="288"><p>assigned_to = "Alejandra Prenatt"</p></td></tr><tr><td style="border: solid windowtext 1.0pt; border-top: none; padding: 0 5.4pt 0 5.4pt;" valign="top" width="66"><p>Subject:</p></td><td style="border-top: none; border-left: none; border-bottom: solid windowtext 1.0pt; border-right: solid windowtext 1.0pt; padding: 0 5.4pt 0 5.4pt;" valign="top" width="16"><p>=</p></td><td style="border-top: none; border-left: none; border-bottom: solid windowtext 1.0pt; border-right: solid windowtext 1.0pt; padding: 0 5.4pt 0 5.4pt;" valign="top" width="288"><p>This incident Number: ${number} - Assigned to: ${assigned_to}</p></td></tr><tr><td style="border: solid windowtext 1.0pt; border-top: none; padding: 0 5.4pt 0 5.4pt;" valign="top" width="66"><p>Message</p></td><td style="border-top: none; border-left: none; border-bottom: solid windowtext 1.0pt; border-right: solid windowtext 1.0pt; padding: 0 5.4pt 0 5.4pt;" valign="top" width="16"><p>=</p></td><td style="border-top: none; border-left: none; border-bottom: solid windowtext 1.0pt; border-right: solid windowtext 1.0pt; padding: 0 5.4pt 0 5.4pt;" valign="top" width="288"><p>Assigned to: ${assigned_to}</p></td></tr></tbody></table><p>Here is how the notification looks:</p><p><img   alt="event stacked notification.jpg" class="image-6 jive-image" src="972cd58adb58d304b322f4621f9619a5.iix" style="width: 620px; height: 182px; display: block; margin-left: auto; margin-right: auto;"/></p><p></p><p>I tested it by creating the two quick changes in incident:</p><ul><li>Then go to Incident table and assign an incident to "David Loo" (internally, event 1 fires)</li><li>then quickly assign it to "<span style="color: #3334ca;">Alejandra Prenatt.</span>" (internally, event 2 fires)</li></ul><p></p><p>You will receive two notifications with the same subject and recipient is <span style="color: #3334ca;">"Alejandra Prenatt.</span>" Reviewing the logic, you can see the first update 'Assigned to' = "David Loo" (event 1) on which the <a title="ki.servicenow.com/index.php?title=Events_and_Email_Notification#gsc.tab=0" href="http://wiki.servicenow.com/index.php?title=Events_and_Email_Notification#gsc.tab=0">email notification</a> SHOULD HAVE NOT PASSED. However, another update with 'Assigned to' = "Alejandra Prenatt" happens (event 2). In practice, there is a delay for the event to be processed, the current record 'Assigned to' = "Alejandra Prenatt" which now matches the condition and when processing event 1 and 2, it sends both notifications.</p><p></p><p><img   alt="same notification passed.jpg" class="image-7 jive-image" src="a2f5784edb9c57049c9ffb651f9619de.iix" style="width: 620px; height: 230px; display: block; margin-left: auto; margin-right: auto;"/></p><p></p><p><strong>This is a normal but unwanted behavior.</strong> Keep that in mind when designing notifications.</p><p>However, there are multiple workarounds.</p><pre __default_attr="success" __jive_macro_name="alert" alert="success" class="jive_text_macro jive_macro_alert" data-renderedposition="2682.683349609375_8_917_64"><p>One solution is to <a title="ki.servicenow.com/index.php?title=Events_and_Email_Notification#gsc.tab=0" href="http://wiki.servicenow.com/index.php?title=Events_and_Email_Notification#gsc.tab=0">create specific events</a> that get used on those specific cases instead of conditions based on data that may change, then limit the notifications to those events</p></pre><h2>Workaround #1: Using event parm1 values to overcome the events sending the same notification message</h2><p>You can modify the <a title="ki.servicenow.com/index.php?title=Events_and_Email_Notification#gsc.tab=0" href="http://wiki.servicenow.com/index.php?title=Events_and_Email_Notification#gsc.tab=0">email notification</a> condition to validate by the data passed on event.parm1 or event.parm2.</p><p></p><p>Here is an example, changing the notification advanced condition:</p><p>Advanced condition =</p><pre __default_attr="javascript" __jive_macro_name="code" class="jive_macro_code _jivemacro_uid_14465622817611979 jive_text_macro" data-renderedposition="2904.683349609375_8_917_96" jivemacro_uid="_14465622817611979"><p>checkAssignedToUser();</p><p>// Check if the parameter provided is the user</p><p>function checkAssignedToUser() {</p><p>       var vbool = (event.parm1 == 'Alejandra Prenatt');</p><p>       return vbool;</p><p>}</p></pre><p></p><p>Here is how it looks in the notification:</p><p><img   alt="overcome events.jpg" class="image-8 jive-image" src="71a53771db50d3041dcaf3231f96195c.iix" style="width: 620px; height: 258px; display: block; margin-left: auto; margin-right: auto;"/></p><p>I tested it by creating the two quick changes in incident: Then go to Incident table and assign an incident to "Charles Tylor (Duty Manager)," then quickly assigned it to "Alejandra Prenatt."</p><p></p><p>Two events were generated on 'incident.assigned.' One contains parm1="Alexandra Prennatt" and the other parm1="Charles Tylor (Duty Manager)." Even when current.assigned is "Alexandra Prenatt," the event that has parm1 parameter = "Charles Tylor (Duty Manager)" does not match the condition and it does not generate a notification, so <strong>only one notification is sent to "Alejandra Prenatt."</strong></p><p></p><p></p><h2>Workaround #2: Use the notification weight to overcome duplicated email</h2><p>Another option is to set the weight to a value higher than zero (0). By setting the weight to a value more than zero, it will cause the business rule to "Ignore duplicates" on the sysemail table to trigger and send any duplicated emails into the ignored mailbox. This options is easier and cleaner than the previous workaround but it generates an unwanted email in the ignored mailbox.</p><p></p><p>On my case, I set the weight to 10. Then retested,</p><p><img   alt="email weight.jpg" class="image-9 jive-image" src="c1cf67f9dbd4df04e9737a9e0f961959.iix" style="width: 620px; height: 325px; display: block; margin-left: auto; margin-right: auto;"/></p><p></p><p></p><p>I tested it by creating the two quick changes in incident:   Then go to Incident table and assign an incident to "David Loo," then</p><p>quickly to "Alejandra Prenatt."</p><p>The system generated two emails to "Alejandra Prenatt." However, only one email remains on ready to send. The other was sent to the ignored mailbox.</p><pre __default_attr="warning" __jive_macro_name="alert" alert="warning" class="jive_text_macro jive_macro_alert" data-renderedposition="4116.68310546875_8_917_43"><p>This only works if both emails are in 'ready-to-send' state at the time the last event is processed.</p></pre><p></p><p><img   alt="2015-11-02_2206-Stack08.png" class="image-5 jive-image" src="69a57fb9db9cdfc0b322f4621f96193e.iix" style="width: 620px; height: 142px;"/></p><p></p><p></p><p>In conclusion, please be aware of the time gap between when the event was generated and when the <a title="ki.servicenow.com/index.php?title=Events_and_Email_Notification#gsc.tab=0" href="http://wiki.servicenow.com/index.php?title=Events_and_Email_Notification#gsc.tab=0">event was processed</a>. This is normal behavior that can cause unwanted results like notifications that look like duplicates.</p><p></p><p></p><p>More information can be found here:</p><ul><li><p><a href="https://hi.service-now.com/kb_view.do?sysparm_article=KB0540674" title="https://hi.service-now.com/kb_view.do?sysparm_article=KB0540674">Email Resources Page (KB0540674)</a> </p></li><li><p><a title="" _jive_internal="true" href="/community?id=community_blog&sys_id=ae9caee1dbd0dbc01dcaf3231f96193c">3 steps to determine if and why the event processor is unable to start</a></p></li><li><p><a title="" _jive_internal="true" href="/community?id=community_blog&sys_id=f0dc6665dbd0dbc01dcaf3231f961955">Diagnosing and remedying stuck event processes</a></p></li><li><p><a title="" _jive_internal="true" href="/community?id=community_blog&sys_id=c8edaae9dbd0dbc01dcaf3231f96199b">Docs: Additional email properties</a></p></li><li><p><a title="" _jive_internal="true" href="https://docs.servicenow.com/administer/reference_pages/reference/r_AvailableSystemProperties.html">Docs: Available system properties</a></p></li><li><p><a _jive_internal="true" href="/community?id=community_blog&sys_id=ae9caee1dbd0dbc01dcaf3231f96193c" title="https://docs.servicenow.com/bundle/istanbul-servicenow-platform/page/administer/notification/task/t_CreateANotification.html">Docs: Create an email notification</a> </p></li><li><p><a href="https://docs.servicenow.com/bundle/istanbul-servicenow-platform/page/administer/notification/concept/c_NotificationExamples.html" title="https://docs.servicenow.com/bundle/istanbul-servicenow-platform/page/administer/notification/concept/c_NotificationExamples.html">Docs: Notification examples</a> </p></li><li><p><a href="https://docs.servicenow.com/bundle/istanbul-servicenow-platform/page/script/server-scripting/concept/c_ScriptingForEmailNotifications.html" title="https://docs.servicenow.com/bundle/istanbul-servicenow-platform/page/administer/notification/reference/notifications.html">Docs: Notifications</a> </p></li><li><p><a _jive_internal="true" href="/people/jonnyseymour/content?filterID=contentstatus%5Bpublished%5D%7Eobjecttype%7Eobjecttype%5Bblogpost%5D" title="https://docs.servicenow.com/bundle/istanbul-servicenow-platform/page/script/server-scripting/concept/c_ScriptingForEmailNotifications.html">Docs: Scripting for email notifications</a> </p></li><li><p><a title="ocs.servicenow.com/bundle/istanbul-servicenow-platform/page/administer/notification/reference/notifications.html" href="https://docs.servicenow.com/bundle/istanbul-servicenow-platform/page/administer/notification/reference/notifications.html">Troubleshooting email notifications - Send to the Event Creator</a></p></li><li><p><a title="i.service-now.com/kb_view.do?sysparm_article=KB0547784" href="https://hi.service-now.com/kb_view.do?sysparm_article=KB0547784">Troubleshooting Outbound Email (KB0521382)</a></p></li><li><p><a title="" _jive_internal="true" href="https://hi.service-now.com/kb_view.do?sysparm_article=KB0528671">Troubleshooting stuck event process (KB0547784)</a></p></li><li><p><a title="ocs.servicenow.com/bundle/istanbul-servicenow-platform/page/administer/notification/task/t_CreateANotification.html" href="https://docs.servicenow.com/bundle/istanbul-servicenow-platform/page/administer/notification/task/t_CreateANotification.html">Verifying the recipient has an email address (KB0528669)</a></p></li><li><p><a title="" _jive_internal="true" href="https://docs.servicenow.com/administer/reference_pages/reference/r_AdditionalProperties.html">Verifying the recipient's email address is properly formatted (KB0528671)</a></p></li><li><p><a title="" _jive_internal="true" href="/people/jonnyseymour/content?filterID=contentstatus%5Bpublished%5D%7Eobjecttype%7Eobjecttype%5Bblogpost%5D">My other blogs</a></p></li></ul>