---
title: "Performance considerations when using ASYNC Business Rules"
date: 2016-01-07T19:59:05.000Z
link: "https://community.servicenow.com/community?id=community_blog&sys_id=64ecea65dbd0dbc01dcaf3231f961929"
---
<p style="text-align: left;">If you've had a chance to review Business Rule Best Practices (Wiki link: <a title="ki.servicenow.com/index.php?title=Business_Rules_Best_Practices#gsc.tab=0" href="http://wiki.servicenow.com/index.php?title=Business_Rules_Best_Practices#gsc.tab=0">here</a>) then you will know an important consideration is knowing WHEN to run business rules. This post focuses on ASYNC business rules since these are commonly used to address performance issues. When used correctly, ASYNC business rules can provide an instance-wide performance boost to some transactions. However, there's a few scenarios I would like to draw your attention to. To do that let's first begin by understanding how ASYNC business rules execute in the platform.</p><p style="text-align: left;"></p><p style="text-align: justify;">What happens when a user action triggers an ASYNC business rule: the platform creates a scheduled job (inserts a record in <strong><em>sys_trigger</em></strong> table) from the business rule <strong><em>after</em></strong> the user submits the form and <strong><em>after</em></strong> any action is taken on the record on the database. From this point of view, the ASYNC business rules are similar to <strong><em>after</em></strong> business rules, but ASYNC rules run in the background, allowing the user to carry out without having to wait for the business rule to complete (<strong><em>after</em></strong> rules are executed synchronously, so the user has to wait for the business rule to complete before gets the control back).</p><p style="text-align: justify;"></p><p class="p1">Asynchronous business rules are generally fine if they run quickly. However, depending on the frequency and duration of execution, they can be detrimental. Normal Business Rules can also be detrimental if they run slowly but the effects are different. The following explains some of the differences.</p><ul><li>Poorly performing Asynchronous business rules:<ul class="ul2"><li>The user transaction that triggered the business rule will complete before the Business Rule is run</li><li>The user will be able to immediately perform a second transaction without waiting for the Business Rule to complete</li><li>The Business Rule will consume a Scheduler Worker (8) as long as it runs. If several users are doing similar transactions that trigger same ASYNC business rule that takes a long time to execute we could potentially end up with all Scheduler Workers running only the jobs triggered by the ASYNC business rule. In that case:<ul class="ul3"><li>SLAs updates will be delayed for the period of ASYNC business rule runtime</li><li>Events processing will be delayed as well for the period of ASYNC business rule runtime (this in turn can cause emails delays)</li><li>Discovery sensors processing will be delayed</li><li>...</li></ul></li></ul></li><li>Poorly performing Synchronous business rules:<ul><li>The business rule transaction will be same as user transaction so it will consume a Default semaphore (16) as long as it runs</li><li>The user will not be able to perform a second transaction until the Business Rules completes and the transaction finishes</li><li>If several users are doing similar transactions that trigger same SYNC business rule we could potentially end up with all Default semaphores consumed (16) with transactions for that particular SYNC business rule. In that case:<ul class="ul3"><li>New user transactions will be queued until a semaphores is available</li></ul></li></ul></li></ul><p style="text-align: justify;"></p><p style="text-align: justify;">To give an example of an ASYNC business rule I created one like this:</p><p style="text-align: justify;"></p><p style="text-align: justify;"><span style="font-size: 12pt;"><img   class="image-1 jive-image" height="335" src="738edc06db985344e9737a9e0f96193b.iix" style="max-width: 1200px; max-height: 900px; width: 627px; height: 334.973px;" width="627"/></span></p><p style="text-align: justify;"><span style="font-size: 12pt;"><img   class="image-2 jive-image" height="333" src="8cb044cadb585fc068c1fb651f9619b7.iix" style="max-width: 1200px; max-height: 900px; width: 623px; height: 332.836px;" width="623"/></span></p><p style="text-align: justify;"></p><p>Now, when I insert/update an incident the business rule will be triggered and platform creates a scheduled job like this:</p><p style="text-align: justify;"></p><p style="text-align: justify;"><img   class="image-3 jive-image" height="270" src="2e00258adb9c1b04ed6af3231f96191c.iix" style="max-width: 1200px; max-height: 900px; width: 628px; height: 269.813px;" width="628"/></p><p style="text-align: justify;"></p><p><span style="font-size: 10pt;">In the above print screen you can see that:</span></p><p></p><ol style="list-style-type: decimal;"><li><span style="font-size: 10pt;">Scheduled job has a name under the form: "ASYNC: &lt;name of business rule&gt;": "ASYNC: TestingASYNCBR" for my example</span></li><li><span style="font-size: 10pt;">In Job context we see a reference to the business rule sys_id (marked with the red rectangle)</span></li></ol><p></p><p><span style="font-size: 10pt;">With above information it's easy to identify what business rule has triggered this particular scheduled job.</span></p><p></p><p><span style="font-size: 10pt;">If ASYNC business gives controls back to user immediately (great user experience), why do we need to think about performance considerations?</span></p><p></p><p><span style="font-size: 10pt;">As these business rules run in the background, their actions can cause server side contention / performance degradation. Running in the background means they will be run under one of the available workers (each application node typically has 8 workers).</span></p><p style="text-align: justify;"></p><p><span style="font-size: 10pt;"><strong>Scenario 1:</strong> ASYNC Business Rules take a long time to execute</span></p><p></p><p><span style="font-size: 10pt;">If I consider for testing my own instance (which has only one application node) and I take the example provided previously and modify gs.sleep like this:</span></p><p></p><pre __default_attr="javascript" __jive_macro_name="code" class="_jivemacro_uid_14521804077298237 jive_macro_code jive_text_macro" data-renderedposition="2097.546875_8_1192_16" jivemacro_uid="_14521804077298237"><span style="font-size: 10.0pt; font-family: 'Courier New';">gs.sleep(1000000);</span></pre><p></p><p><span style="font-size: 10pt;">then do quickly more than 8 updates on incidents, I end up with the following:</span></p><p style="text-align: justify;"></p><p style="text-align: justify;"><img   class="jive-image image-4" height="216" src="cecd340edb509f048c8ef4621f96193f.iix" style="max-width: 1200px; max-height: 900px; width: 652px; height: 216.263px;" width="652"/></p><p></p><p><span style="font-size: 10pt;">Checking stats.do page (<a title="" _jive_internal="true" href="https:" rel="nofollow" target="_blank">https://</a>&lt;myinstance&gt;.service-now.com/stats.do) I see the following:</span></p><p align="center" style="text-align: center;"><span style="font-size: 8.0pt;">   </span></p><hr align="center" noshade="noshade" size="2" style="color: black;" width="100%"/><p><span style="color: black; font-size: 8.0pt; font-family: Verdana;"><strong>Background Scheduler</strong></span><span style="font-size: 8.0pt; font-family: Verdana; color: black;"><br/> Number of workers: 8<br/> </span><span style="color: red; font-size: 8.0pt; font-family: Verdana;"><strong>Queue length: 12</strong></span><span style="font-size: 8.0pt; font-family: Verdana; color: black;"><br/> Mean queue age: 0:01:09.989<br/> System ID: &lt;hostname&gt;.ams3.service-now.com:&lt;node_name&gt;<br/> Total jobs: 606747<br/> Total burst workers: 1<br/> Scheduler run state: true<br/> <br/> <strong>Scheduler Workers</strong><br/> </span><span style="font-size: 8.0pt; font-family: Verdana;">glide.scheduler.worker.0</span><span style="font-size: 8.0pt; font-family: Verdana; color: black;"><br/> Current job: ASYNC: TestingASYNCBR<br/> Job started: Mon Jan 04 23:48:22 PST 2016<br/> Job duration: 0:01:55.764<br/> Total jobs: 3787<br/> Mean duration: 0:00:00.234<br/> </span></p><p></p><p><span style="font-size: 8.0pt; font-family: Verdana; color: black;"> <span style="font-size: 8.0pt; font-family: Verdana;">glide.scheduler.worker.1</span><span style="font-size: 8.0pt; font-family: Verdana; color: black;"><br/> Current job: ASYNC: TestingASYNCBR<br/> Job started: Mon Jan 04 23:47:49 PST 2016<br/> Job duration: 0:02:27.832<br/> Total jobs: 3689<br/> Mean duration: 0:00:00.416<br/> <br/> </span><span style="font-size: 8.0pt; font-family: Verdana;">glide.scheduler.worker.2</span><span style="font-size: 8.0pt; font-family: Verdana; color: black;"><br/> Current job: ASYNC: TestingASYNCBR<br/> Job started: Mon Jan 04 23:48:10 PST 2016<br/> Job duration: 0:02:07.411<br/> Total jobs: 3794<br/> Mean duration: 0:00:00.134<br/> <br/><span style="font-size: 8.0pt; font-family: Verdana;">glide.scheduler.worker.3</span><span style="font-size: 8.0pt; font-family: Verdana; color: black;"><br/> Current job: ASYNC: TestingASYNCBR<br/> Job started: Mon Jan 04 23:47:50 PST 2016<br/> Job duration: 0:02:27.740<br/> Total jobs: 3810<br/> Mean duration: 0:00:00.139<br/> <br/> </span></span></span><span style="font-size: 8.0pt; font-family: Verdana;">glide.scheduler.worker.4</span></p><p><span style="font-size: 8.0pt; font-family: Verdana; color: black;"> Current job: ASYNC: TestingASYNCBR<br/> Job started: Mon Jan 04 23:48:00 PST 2016<br/> Job duration: 0:02:17.799<br/> Total jobs: 3796<br/> Mean duration: 0:00:00.158<br/> </span><span style="font-size: 8.0pt;"><br/> </span><span style="font-size: 8.0pt; font-family: Verdana;">glide.scheduler.worker.5</span><span style="font-size: 8.0pt; font-family: Verdana; color: black;"><br/> Current job: ASYNC: TestingASYNCBR<br/> Job started: Mon Jan 04 23:47:50 PST 2016<br/> Job duration: 0:02:27.712<br/> Total jobs: 3720<br/> Mean duration: 0:00:00.353<br/> <br/> </span><span style="font-size: 8.0pt; font-family: Verdana;">glide.scheduler.worker.6</span><span style="font-size: 8.0pt; font-family: Verdana; color: black;"><br/> Current job: ASYNC: TestingASYNCBR<br/> Job started: Mon Jan 04 23:47:59 PST 2016<br/> Job duration: 0:02:17.991<br/> Total jobs: 3772<br/> Mean duration: 0:00:00.170<br/> <br/> </span><span style="font-size: 8.0pt; font-family: Verdana;">glide.scheduler.worker.7</span><span style="font-size: 8.0pt; font-family: Verdana; color: black;"><br/> Current job: ASYNC: TestingASYNCBR<br/> Job started: Mon Jan 04 23:48:09 PST 2016<br/> Job duration: 0:02:07.812<br/> Total jobs: 3805<br/> Mean duration: 0:00:00.141</span></p><p align="center" style="text-align: center;"><span style="font-size: 8.0pt;">   </span></p><hr align="center" noshade="noshade" size="2" style="color: black;" width="100%"/><p></p><p><span style="font-size: 10pt;">The stats.do page gives me the following information:</span></p><p></p><ol style="list-style-type: decimal;"><li><span style="font-size: 10pt;">All workers are busy now with running instances of that ASYNC business rule</span></li><li><span style="font-size: 10pt;">Running several times stats.do shows me that "<strong>Queue length</strong>" (marked with red in above stats.do output) is slowly increasing, meaning other jobs are queued waiting to run.</span></li></ol><p></p><p><span style="font-size: 10pt;">Clicking on the blue link on one of the workers like:</span></p><p></p><p><span style="font-size: 8.0pt; font-family: Verdana;">glide.scheduler.worker.4</span></p><p></p><p><span style="font-size: 10pt;">we get the stack trace of this job that points out what job it is and at which line code is spending the time.</span></p><p align="center" style="text-align: center;"></p><pre __default_attr="javascript" __jive_macro_name="code" class="jive_macro_code jive_text_macro _jivemacro_uid_14521803915091492" data-renderedposition="3755.9375_8_1192_480" jivemacro_uid="_14521803915091492"><p><span style="font-size: 8.0pt; font-family: Verdana; color: black;">Threads for: Demo Server @ </span><span style="color: blue; text-decoration: underline; font-size: 8.0pt; font-family: Verdana;">&lt;hostname&gt;.ams3.service-now.com:&lt;app_node_port&gt;</span><span style="font-size: 8.0pt; font-family: Verdana; color: black;"> at: Mon Jan 04 23:49:02 PST 2016 (</span><a href="http://app55035.ams3.service-now.com:16022/threads.do"><span style="font-size: 8.0pt; font-family: Verdana;">Refresh</span></a><span style="font-size: 8.0pt; font-family: Verdana; color: black;">)<br/> Connected to cluster node: &lt;hostname&gt;.ams3.service-now.com:&lt;app_node_name&gt;<br/> Build date: 11-07-2015_1248<br/> Build tag: glide-geneva-08-25-2015__patch0-hotfix1-11-06-2015<br/> <br/> </span></p><p><span style="font-size: 8.0pt; font-family: Courier; color: black;">main,glide.scheduler.worker.0,4,ASYNC: TestingASYNCBR (40248 ms) </span></p><p><span style="font-size: 8.0pt; font-family: Courier; color: black;">j</span><span style="font-size: 8.0pt; font-family: Courier; color: black;">ava.lang.Thread.sleep(Native Method) </span></p><p><span style="font-size: 8.0pt; font-family: Courier; color: black;">com.glide.script.GlideSystem.js_sleep(GlideSystem.java:978)                 </span></p><p><span style="font-size: 8.0pt; font-family: Courier; color: black;">sun.reflect.GeneratedMethodAccessor637.invoke(Unknown Source) </span></p><p><span style="font-size: 8.0pt; font-family: Courier; color: black;">sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)                 </span></p><p><span style="font-size: 8.0pt; font-family: Courier; color: black;">java.lang.reflect.Method.invoke(Method.java:597) </span></p><p><span style="font-size: 8.0pt; font-family: Courier; color: black;">org.mozilla.javascript.FunctionObject.doInvoke(FunctionObject.java:597) </span></p><p><span style="font-size: 8.0pt; font-family: Courier; color: black;">org.mozilla.javascript.FunctionObject.call(FunctionObject.java:504) </span></p><p><span style="font-size: 8.0pt; font-family: Courier; color: black;">org.mozilla.javascript.ScriptRuntime.call(ScriptRuntime.java:1227)                 </span></p><p><strong><span style="color: red; font-size: 8.0pt; font-family: Courier;">org.mozilla.javascript.gen.c7635.call(sys_trigger.b878bd496fb01600e5e2e0526e3ee44c:4)</span><span style="font-size: 8.0pt; font-family: Courier; color: black;"> </span></strong></p><p><span style="font-size: 8.0pt; font-family: Courier; color: black;">org.mozilla.javascript.ScriptRuntime.call(ScriptRuntime.java:1227) </span></p><p><span style="font-size: 8.0pt; font-family: Courier; color: black;">org.mozilla.javascript.gen.c7636.call(sys_trigger.b878bd496fb01600e5e2e0526e3ee44c:1) </span></p><p><span style="font-size: 8.0pt; font-family: Courier; color: black;">org.mozilla.javascript.gen.c7636.exec(sys_trigger.b878bd496fb01600e5e2e0526e3ee44c) </span></p><p><span style="font-size: 8.0pt; font-family: Courier; color: black;">com.glide.script.ScriptEvaluator.execute(ScriptEvaluator.java:233) </span></p><p><span style="font-size: 8.0pt; font-family: Courier; color: black;">com.glide.script.ScriptEvaluator.evaluateString(ScriptEvaluator.java:105) </span></p><p><span style="font-size: 8.0pt; font-family: Courier; color: black;">com.glide.script.ScriptEvaluator.evaluateString(ScriptEvaluator.java:72)             </span></p><p><span style="font-size: 8.0pt; font-family: Courier; color: black;">com.glide.script.Evaluator.evaluatePossiblePrefixedString(Evaluator.java:192)</span>       </p><p><span style="font-size: 8.0pt; font-family: Courier; color: black;">com.glide.job.RunScriptJob.evaluateScript(RunScriptJob.java:158)   </span></p><p><span style="font-size: 8.0pt; font-family: Courier; color: black;">com.glide.job.RunScriptJob.runScript(RunScriptJob.java:121)                 </span></p><p><span style="font-size: 8.0pt; font-family: Courier; color: black;">com.glide.job.RunScriptJob.execute(RunScriptJob.java:88) </span></p><p><span style="font-size: 8.0pt; font-family: Courier; color: black;">com.glide.schedule.JobExecutor.execute(JobExecutor.java:80) </span></p><p><span style="font-size: 8.0pt; font-family: Courier; color: black;">com.glide.schedule.GlideScheduleWorker.executeJob(GlideScheduleWorker.java:191) </span></p><p><span style="font-size: 8.0pt; font-family: Courier; color: black;">com.glide.schedule.GlideScheduleWorker.process(GlideScheduleWorker.java:135) </span></p><p><span style="font-size: 8.0pt; font-family: Courier; color: black;">com.glide.schedule.GlideScheduleWorker.run(GlideScheduleWorker.java:57)</span></p></pre><p align="center" style="text-align: center;"><span style="font-size: 8.0pt;">   </span></p><p></p><p><span style="font-size: 10pt;">In my case:</span></p><p></p><pre __default_attr="javascript" __jive_macro_name="code" class="_jivemacro_uid_14521803816606268 jive_macro_code jive_text_macro" data-renderedposition="4313.9375_8_1192_16" jivemacro_uid="_14521803816606268"><p><span style="color: red; font-size: 8.0pt; font-family: Courier;"><strong>org.mozilla.javascript.gen.c7635.call(sys_trigger.b878bd496fb01600e5e2e0526e3ee44c:4)</strong></span></p></pre><p></p><p><span style="font-size: 10pt;">points to the job triggered by the ASYNC business rule which has the sleep call at line 4:</span></p><p></p><p><span style="font-size: 8.0pt; font-family: Verdana; color: black;"><img   class="image-5 jive-image" height="328" src="222b5002db9c17049c9ffb651f9619ee.iix" style="max-width: 1200px; max-height: 900px; width: 667px; height: 328.155px;" width="667"/></span></p><p></p><p></p><p><span style="font-size: 10pt;">A quick look into sys_trigger table shows all the queued jobs:</span></p><p></p><p><span style="font-size: 8.0pt; font-family: Verdana; color: black;"><img   class="image-6 jive-image" height="326" src="416affbddb50db048c8ef4621f961934.iix" style="max-width: 1200px; max-height: 900px; width: 679px; height: 326.404px;" width="679"/></span></p><p style="text-align: justify;"></p><p></p><p><span style="font-size: 10pt;"><strong>Conclusion</strong>: the above scenario can delay the execution of one or more important scheduled jobs (including out of box ones), like "events process", "SMTP Sender", etc and this is usually translated into performance degradation. Imagine that your emails will be sent with at least 1000s delay.</span></p><p></p><p><span style="font-size: 10pt;"><em><strong>Note</strong> : ASYNC jobs are deleted from the sys_trigger table after execution is complete, so gather your evidence quickly!</em></span></p><p></p><p><span style="font-size: 10pt;"><strong>Scenario 2:</strong> ASYNC Business Rules get stuck</span></p><p></p><p><span style="font-size: 10pt;">This scenario is based on real incidents opened by customers of ServiceNow.</span></p><p><span style="font-size: 10pt;">Consider the following example of ASYNC business rule code:</span></p><p></p><p><img   class="image-7 jive-image" height="392" src="33566d86dbd0df048c8ef4621f96194c.iix" style="width: 706px; height: 392.125px;" width="706"/></p><p></p><p><span style="font-size: 10pt;">Do you already see the mistake in the code?</span></p><p></p><p><span style="font-size: 10pt;">If not, let's perform the test by updating at least 8 incidents. Checking after stats.do page I see:</span></p><p align="center" style="text-align: center;"><span style="font-size: 8.0pt;">   </span></p><hr align="center" noshade="noshade" size="2" style="color: black;" width="100%"/><p>   <span style="color: black; font-size: 8.0pt; font-family: Verdana;"><strong>Background Scheduler</strong></span><span style="font-size: 8.0pt; font-family: Verdana; color: black;"><br/> Number of workers: 8<br/> Queue length: 10<br/> Mean queue age: 0:00:30.398<br/> System ID: &lt;hostname&gt;.ams3.service-now.com:&lt;app_node_name&gt;<br/> Total jobs: 611108<br/> Total burst workers: 12<br/> Scheduler run state: true<br/> <br/> <strong>Scheduler Workers</strong><br/> </span><span style="font-size: 8.0pt; font-family: Verdana;">glide.scheduler.worker.0</span><span style="font-size: 8.0pt; font-family: Verdana; color: black;"><br/> Current job: ASYNC: TestingASYNCBR<br/> Job started: Tue Jan 05 02:23:11 PST 2016<br/> Job duration: 0:00:46.601<br/> Total jobs: 4326<br/> Mean duration: 0:00:00.429</span></p><p></p><p><span style="font-size: 8.0pt; font-family: Verdana;"> glide.scheduler.worker.1</span><span style="font-size: 8.0pt; font-family: Verdana; color: black;"><br/> Current job: ASYNC: TestingASYNCBR<br/> Job started: Tue Jan 05 02:22:49 PST 2016<br/> Job duration: 0:01:08.084<br/> Total jobs: 4243<br/> Mean duration: 0:00:00.589<br/> <br/> </span><span style="font-size: 8.0pt; font-family: Verdana;">glide.scheduler.worker.2</span><span style="font-size: 8.0pt; font-family: Verdana; color: black;"><br/> Current job: ASYNC: TestingASYNCBR<br/> Job started: Tue Jan 05 02:22:40 PST 2016<br/> Job duration: 0:01:17.778<br/> Total jobs: 4314<br/> Mean duration: 0:00:00.372<br/> <br/> </span><span style="font-size: 8.0pt; font-family: Verdana;">glide.scheduler.worker.3</span><span style="font-size: 8.0pt; font-family: Verdana; color: black;"><br/> Current job: ASYNC: TestingASYNCBR<br/> Job started: Tue Jan 05 02:22:29 PST 2016<br/> Job duration: 0:01:27.990<br/> Total jobs: 4357<br/> Mean duration: 0:00:00.348</span></p><p></p><p><span style="font-size: 8.0pt; font-family: Verdana; color: black;"> </span><span style="font-size: 8.0pt; font-family: Verdana;">glide.scheduler.worker.4</span><span style="font-size: 8.0pt; font-family: Verdana; color: black;"><br/> Current job: ASYNC: TestingASYNCBR<br/> Job started: Tue Jan 05 02:22:40 PST 2016<br/> Job duration: 0:01:17.517<br/> Total jobs: 4329<br/> Mean duration: 0:00:00.367</span><span style="font-size: 9.0pt; font-family: Verdana; color: black;"><br/> </span><span style="font-size: 8.0pt; font-family: Verdana; color: black;"><br/> </span><span style="font-size: 8.0pt; font-family: Verdana;">glide.scheduler.worker.5</span><span style="font-size: 8.0pt; font-family: Verdana; color: black;"><br/> Current job: ASYNC: TestingASYNCBR<br/> Job started: Tue Jan 05 02:22:29 PST 2016<br/> Job duration: 0:01:28.078<br/> Total jobs: 4256<br/> Mean duration: 0:00:00.540<br/> <br/> </span><span style="font-size: 8.0pt; font-family: Verdana;">glide.scheduler.worker.6</span><span style="font-size: 8.0pt; font-family: Verdana; color: black;"><br/> Current job: ASYNC: TestingASYNCBR<br/> Job started: Tue Jan 05 02:22:40 PST 2016<br/> Job duration: 0:01:17.703<br/> Total jobs: 4298<br/> Mean duration: 0:00:00.377<br/> <br/> </span><span style="font-size: 8.0pt; font-family: Verdana;">glide.scheduler.worker.7</span><span style="font-size: 8.0pt; font-family: Verdana; color: black;"><br/> Current job: ASYNC: TestingASYNCBR<br/> Job started: Tue Jan 05 02:23:00 PST 2016<br/> Job duration: 0:00:57.652<br/> Total jobs: 4355<br/> Mean duration: 0:00:00.347</span></p><p align="center" style="text-align: center;"><span style="font-size: 8.0pt;">   </span></p><hr align="center" noshade="noshade" size="2" style="color: black;" width="100%"/><p></p><p><span style="font-size: 10pt;">Checking stack trace for one of the workers we see:</span></p><p align="center" style="text-align: center;"></p><pre __default_attr="javascript" __jive_macro_name="code" class="jive_macro_code jive_text_macro _jivemacro_uid_14521803552677285" data-renderedposition="7048.9375_8_1192_771" jivemacro_uid="_14521803552677285"><p><span style="font-size: 8.0pt; font-family: Verdana; color: black;">Threads for: Demo Server @ </span><span style="font-size: 8.0pt; font-family: Verdana;">app55035.ams3.service-now.com:16022</span> <span style="font-size: 8.0pt; font-family: Verdana; color: black;">at: Tue Jan 05 02:23:46 PST 2016 (</span><a href="http://app55035.ams3.service-now.com:16022/threads.do"><span style="font-size: 8.0pt; font-family: Verdana;">Refresh</span></a><span style="font-size: 8.0pt; font-family: Verdana; color: black;">)<br/> Connected to cluster node: &lt;hostname&gt;.ams3.service-now.com:&lt;app_node_name&gt;<br/> Build date: 11-07-2015_1248<br/> Build tag: glide-geneva-08-25-2015__patch0-hotfix1-11-06-2015<br/> <br/></span></p><p><span style="font-size: 8.0pt; font-family: Cambria; color: black;">main,glide.scheduler.worker.4,4,ASYNC: TestingASYNCBR (66511 ms) </span></p><p><span style="font-size: 8.0pt; font-family: Cambria; color: black;">com.glide.sys.cache.CacheMan.get(CacheMan.java:83) </span></p><p><span style="font-size: 8.0pt; font-family: Cambria; color: black;">com.glide.sys.cache.CacheManager.get(CacheManager.java:63) </span></p><p><span style="font-size: 8.0pt; font-family: Cambria; color: black;">com.glide.db.TableDescriptorProvider.getSchemaFromCache(TableDescriptorProvider.java:86) </span></p><p><span style="font-size: 8.0pt; font-family: Cambria; color: black;">com.glide.db.TableDescriptor.getSchema(TableDescriptor.java:191) </span></p><p><span style="font-size: 8.0pt; font-family: Cambria; color: black;">com.glide.db.TableDescriptor.getElementDescriptor(TableDescriptor.java:355) </span></p><p><span style="font-size: 8.0pt; font-family: Cambria; color: black;">com.glide.db.TableDescriptor.getElementDescriptor(TableDescriptor.java:344) </span></p><p><span style="font-size: 8.0pt; font-family: Cambria; color: black;">com.glide.db.domain.DomainMonitor.onExecute0(DomainMonitor.java:90) </span></p><p><span style="font-size: 8.0pt; font-family: Cambria; color: black;">com.glide.db.domain.DomainMonitor.hackBeforeExecute(DomainMonitor.java:67) </span></p><p><span style="font-size: 8.0pt; font-family: Cambria; color: black;">com.glide.db.domain.DomainSupport.hackBeforeExecute(DomainSupport.java:935)                 </span></p><p><span style="font-size: 8.0pt; font-family: Cambria; color: black;">com.glide.db.DBCompositeAction.setSystemFields(DBCompositeAction.java:331) </span></p><p><span style="font-size: 8.0pt; font-family: Cambria; color: black;">com.glide.db.DBCompositeAction.beforeExecute(DBCompositeAction.java:74) </span></p><p><span style="font-size: 8.0pt; font-family: Cambria; color: black;">com.glide.db.DBInsert.beforeExecute(DBInsert.java:481)                 </span></p><p><span style="font-size: 8.0pt; font-family: Cambria; color: black;">com.glide.db.DBAction.executeAndReturnException(DBAction.java:165) </span></p><p><span style="font-size: 8.0pt; font-family: Cambria; color: black;">com.glide.script.GlideRecordITable.insert(GlideRecordITable.java:116)</span>           </p><p><span style="font-size: 8.0pt; font-family: Cambria; color: black;">com.glide.script.GlideRecord.insert(GlideRecord.java:4392) </span></p><p><span style="font-size: 8.0pt; color: black;">com.glide.script.GlideRecord.insert(GlideRecord.java:4323)                 </span></p><p><span style="font-size: 8.0pt; color: black;">com.glide.sys.SysLog.log(SysLog.java:183)                 </span></p><p><span style="font-size: 8.0pt; color: black;">com.glide.sys.SysLog.log(SysLog.java:149)</span><span style="font-size: 9.0pt; color: black;">                 </span></p><p><span style="font-size: 8.0pt; color: black;">com.glide.sys.SysLog.info(SysLog.java:33)                 </span></p><p><span style="font-size: 8.0pt; color: black;">com.glide.sys.SysLog.info(SysLog.java:24)                 </span></p><p><span style="font-size: 8.0pt; color: black;">com.glide.script.GlideSystem.jsFunction_log(GlideSystem.java:1144)                 </span></p><p><span style="font-size: 8.0pt; color: black;">sun.reflect.GeneratedMethodAccessor729.invoke(Unknown Source)                 </span></p><p><span style="font-size: 8.0pt; color: black;">sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)                 </span></p><p><span style="font-size: 8.0pt; color: black;">java.lang.reflect.Method.invoke(Method.java:597)                 </span></p><p><span style="font-size: 8.0pt; color: black;">org.mozilla.javascript.FunctionObject.doInvoke(FunctionObject.java:597)                 </span></p><p><span style="font-size: 8.0pt; color: black;">org.mozilla.javascript.FunctionObject.call(FunctionObject.java:504)                 </span></p><p><span style="font-size: 8.0pt; color: black;">org.mozilla.javascript.ScriptRuntime.call(ScriptRuntime.java:1227)                 </span></p><p><span style="color: red; font-size: 8.0pt;">org.mozilla.javascript.gen.c7659.call(sys_trigger.e6db56c16ff01600e5e2e0526e3ee44f:9)</span><span style="font-size: 8.0pt; color: black;">                 </span></p><p><span style="font-size: 8.0pt; color: black;">org.mozilla.javascript.ScriptRuntime.call(ScriptRuntime.java:1227)                 </span></p><p><span style="font-size: 8.0pt; color: black;">org.mozilla.javascript.gen.c7660.call(sys_trigger.e6db56c16ff01600e5e2e0526e3ee44f:1)                 </span></p><p><span style="font-size: 8.0pt; color: black;">org.mozilla.javascript.gen.c7660.exec(sys_trigger.e6db56c16ff01600e5e2e0526e3ee44f)                 </span></p><p><span style="font-size: 8.0pt; color: black;">com.glide.script.ScriptEvaluator.execute(ScriptEvaluator.java:233)                 </span></p><p><span style="font-size: 8.0pt; color: black;">com.glide.script.ScriptEvaluator.evaluateString(ScriptEvaluator.java:105)                 </span></p><p><span style="font-size: 8.0pt; color: black;">com.glide.script.ScriptEvaluator.evaluateString(ScriptEvaluator.java:72)                 </span></p><p><span style="font-size: 8.0pt; color: black;">com.glide.script.Evaluator.evaluatePossiblePrefixedString(Evaluator.java:192)                 </span></p><p><span style="font-size: 8.0pt; color: black;">com.glide.job.RunScriptJob.evaluateScript(RunScriptJob.java:158)                 </span></p><p><span style="font-size: 8.0pt; color: black;">com.glide.job.RunScriptJob.runScript(RunScriptJob.java:121)                 </span></p><p><span style="font-size: 8.0pt; color: black;">com.glide.job.RunScriptJob.execute(RunScriptJob.java:88)                 </span></p><p><span style="font-size: 8.0pt; color: black;">com.glide.schedule.JobExecutor.execute(JobExecutor.java:80)                 </span></p><p><span style="font-size: 8.0pt; color: black;">com.glide.schedule.GlideScheduleWorker.executeJob(GlideScheduleWorker.java:191)                 </span></p><p><span style="font-size: 8.0pt; color: black;">com.glide.schedule.GlideScheduleWorker.process(GlideScheduleWorker.java:135)                 </span></p><p><span style="font-size: 8.0pt; color: black;">com.glide.schedule.GlideScheduleWorker.run(GlideScheduleWorker.java:57)</span></p></pre><p align="center" style="text-align: center;"></p><p></p><p><span style="font-size: 10pt;">Stack trace points to line 9 in the ASYNC business rule which can get a bit confusing as line actually is:</span></p><p></p><pre __default_attr="javascript" __jive_macro_name="code" class="jive_macro_code _jivemacro_uid_14521803434485806 jive_text_macro" data-renderedposition="7903.9375_8_1192_16" jivemacro_uid="_14521803434485806"><span style="font-size: 10.0pt; font-family: 'Courier New';">gs.log('Testing');</span></pre><p></p><p><span style="font-size: 10pt;">How can this cause the job to get stuck in the first place? The error in this case is actually a syntax error on line 8, as I have not properly called <strong>gr.next</strong> function by omitting the parentheses, code required being actually:</span></p><p></p><pre __default_attr="javascript" __jive_macro_name="code" class="jive_macro_code jive_text_macro _jivemacro_uid_145218033506537" data-renderedposition="8003.9375_8_1192_48" jivemacro_uid="_145218033506537"><p><span style="font-size: 10.0pt; font-family: 'Courier New';">while(gr.next()){</span></p><p><span style="font-size: 10.0pt; font-family: 'Courier New';">           //do something</span></p><p><span style="font-size: 10.0pt; font-family: 'Courier New';">}</span></p></pre><p></p><p><span style="font-size: 10pt;">Possible solutions to stop these stuck jobs and stop creation of new ones:</span></p><p></p><ol style="list-style-type: decimal;"><li><span style="font-size: 10pt;">Deactivate the faulty ASYNC business rule</span></li><li><span style="font-size: 10pt;">Go to User Administration -&gt; All Active Transactions. Select each of these transactions and from "Action on select rows" choose Kill.   This might not work for you if you're logged in on one of the application nodes where jobs are not running, so you might need ServiceNow support assistance.</span></li><li><span style="font-size: 10pt;">If above doesn't work only solution in this case is to restart the application node, action done directly by ServiceNow customer support personnel (this would also involve doing step 1 and removing from sys_trigger the faulty jobs).</span></li></ol><p></p><p><span style="font-size: 10pt;"><strong>Conclusion</strong>: the above scenario has much more impact than previous scenario as it causes workers to be stuck forever, until application node is restarted.</span></p><p></p><p><span style="font-size: 10pt;">General performance considerations:</span></p><p></p><ol style="list-style-type: decimal;"><li><span style="font-size: 10pt;">Make sure your ASYNC business rule is properly tested on a subproduction environment and make sure you know what response time is</span></li><li><span style="font-size: 10pt;">Make sure you validate your code (not only for ASYNC business rules, but for every script) from a syntax point of view.</span></li></ol><p></p><p><span style="font-size: 10pt;">If you're also interested in performance considerations when using GlideRecord you can have a look at this post:</span></p><p></p><p><a title="Performance considerations when using GlideRecord" __default_attr="4811" __jive_macro_name="blogpost" class="jive_macro jive_macro_blogpost" data-orig-content="Performance considerations when using GlideRecord" data-renderedposition="8451.515625_8_353_16" href="/community?id=community_blog&sys_id=620deaa5dbd0dbc01dcaf3231f961981">Performance considerations when using GlideRecord</a></p>