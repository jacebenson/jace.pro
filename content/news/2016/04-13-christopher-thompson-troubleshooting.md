---
title: "Troubleshooting MID Server upgrades to Geneva"
date: 2016-04-13T01:21:34.000Z
authors: ["christopher.thompson"]
link: "https://community.servicenow.com/community?id=community_blog&sys_id=59ecea65dbd0dbc01dcaf3231f9619ec"
---
<p>Starting in the Geneva release, there have been some significant changes made with regards to MID Servers. For example, there is a new "validation" process where a MID Server must be "validated" on an instance before it can be used for most automation related activities. Some of the<a title="ocs.servicenow.com/bundle/geneva-release-notes/page/c2/mid-server-rn-2.html" href="https://docs.servicenow.com/bundle/geneva-release-notes/page/c2/mid-server-rn-2.html"> changes to the MID Server </a>and the new <a title="ocs.servicenow.com/bundle/geneva-it-operations-management/page/product/mid_server/concept/c_ManageMIDServerEncryptionKeypairs.html" href="https://docs.servicenow.com/bundle/geneva-it-operations-management/page/product/mid_server/concept/c_ManageMIDServerEncryptionKeypairs.html">encryption process</a> have been recorded in our product documentation.</p><p></p><p>While all this is fine, and in most cases you will not have to worry about these specifics, other than during the initial validation, there have been some issues occurring with the Geneva MID Servers. The issue occurs during upgrades from a previous version such as Fuji, Eureka, etc. More specifically, this issue presents itself in cases when you upgrade your instance to Geneva, then downgrade back to a previous version (ex. clone from another instance still running a previous release), then upgrade back to Geneva again. The issue also occurs if you switch a MID Server that was running on Geneva to another instance running a previous version, then switch back to the Geneva instance.</p><p><img   alt="MID server geneva upgrade.jpg" class="image-6 jive-image" src="a829ec8edb509344e9737a9e0f961916.iix" style="width: 620px; height: 86px; display: block; margin-left: auto; margin-right: auto;"/></p><p>There are many different scenarios that can cause upgrade issues in general. For example, if the proper firewalls are not open to "install.service-now.com or if the "Log on" account being used to run the MID Server and perform the upgrade service does not have local or domain admin access.</p><p></p><p>See <a href="https://docs.servicenow.com/bundle/geneva-it-operations-management/page/product/mid_server/concept/c_MIDServerConnectionPrerequisites.html" title="https://docs.servicenow.com/bundle/geneva-it-operations-management/page/product/mid_server/concept/c_MIDServerConnectionPrerequisites.html">MID Server connection prerequisites</a> and <a href="http://wiki.servicenow.com/index.php?title=MID_Server_Installation#Upgrading_and_Testing" title="http://wiki.servicenow.com/index.php?title=MID_Server_Installation#Upgrading_and_Testing">MID Server Installation upgrading and test</a> for more information or you can check out this <a title="i.service-now.com/kb_view.do?sysparm_article=KB0535180" href="https://hi.service-now.com/kb_view.do?sysparm_article=KB0535180">Troubleshooting a MID Server that is down or not responding</a> Knowledge article for some additional troubleshooting steps as well.</p><p></p><p>However, what I am going to focus on in this blog post are some other areas to investigate against if you run into other upgrade issues, particularly to the Geneva release.</p><p></p><p>We'll explore:</p><ul><li>Encrypted Password in "config.xml"</li><li>"meta.properties" files</li><li>"incoming" upgrade files and the "ServiceNow Platform Distribution Upgrade" service</li></ul><p></p><h1>Encrypted Password in "config.xml"</h1><p>As previously mentioned, starting in this new Geneva release we have a new "validation" and "encryption" process. The new process will affect any passwords that need to be encrypted/decrypted by the MID Server, including the "mid.instance.password" that you may likely be encrypting in the MID Server's "config.xml" file.</p><p></p><p>The validation change can effect your instance when upgrading, downgrading, or switching MID Servers between versions. The encrypted password value, when switching back and forth between versions on Geneva, is not the same as it would mean on Fuji or earlier. You may be seeing this issue occur if you are seeing error messages in your agent logs with regards to "Could not authenticate user" or "User cannot be authenticated or is missing the proper roles". See example below.</p><p style="text-align: center;"><img   alt="Screen Shot 2016-04-20 at 9.59.04 AM.JPG" class="image-11 jive-image" src="dddcc086db509fc03eb27a9e0f961989.iix" style="width: auto; height: auto;"/></p><p>If this is the case, you will want to look into your "config.xml" file and re-input the plain text password value, just as if you were setting up this MID server for the first time. This way, when restarting this MID Server and it reconnects to the instance, the new Geneva encryption process will properly encrypt the password.</p><p></p><p>NOTE: As a part of this new encryption process in Geneva, you will likely see the following two new features that is a part of this encryption process that you <strong>should not</strong> modify or remove for any reason.</p><p></p><h4>1. In the "config.xml" file, you will see a parameter "keypairs.mid_id."</h4><p><img   alt="keypair geneva password.jpg" class="image-7 jive-image" src="761784cadb9cd3041dcaf3231f9619bc.iix" style="height: auto; display: block; margin-left: auto; margin-right: auto;"/></p><p></p><h4>2. In the "agent" folder, you will see a folder "keystore" that contains a file "agent_keystore.jks."</h4><p><img   alt="agent keystore mid server.jpg" class="image-8 jive-image" src="acd8e379db90df04e9737a9e0f961921.iix" style="width: 620px; height: 109px; display: block; margin-left: auto; margin-right: auto;"/></p><p></p><p>Modifying the values or its files will cause serious encryption issues on your MID Server. I meant it.. Serious! Issues.</p><p></p><h1>"meta.properties" files</h1><p>On your MID Servers, under the location "\agent\package\meta", there are 2 files located here "mid-core.meta.properties" and "mid-jre.meta.properties". These property files contain the version information with regards to the core MID server package and the JRE version for this MID Server. In some situations, in cases where the MID Server is being "downgraded" to an earlier version, these files may not get accurately updated to reflect the current version that the MID Server is actually on.</p><p></p><table border="1"><tbody><tr><td><p>For example, when on Geneva, the "core" package should have a naming convention like this below.</p><p><span style="font-size: 10pt; font-family: 'Courier New';">package.filename=mid-core.geneva-08-25-2015__patch3-hotfix2-02-04-2016_02-04-2016_1909.universal.universal.zip</span></p><p></p><p>Whereas a MID Server on a Fuji release may have a value like this in it's "core" properties file.</p><p><span style="font-size: 10pt; font-family: 'Courier New';">package.filename=mid-core.2016-02-23-1231.universal.universal.zip</span></p><p></p><p>So, in this scenario, what you may see is that your MID Server is able to connect to your Geneva instance, however the "version" details on this instance will still show this MID Server as being on a non-Geneva version (ex. 2016-02-23-1231).</p><p></p><p>You may also see an error like this in your agent logs as well.</p><p><span style="font-size: 10pt; font-family: 'courier new', courier;">04/11/16 06:04:09 (621) StartupSequencer SEVERE *** ERROR *** Unable to refresh packages. Not a valid package filename `mid-jre.geneva-08-25-2015_11-29-2015_2130.windows.x86-64.zip`.</span></p><p></p><p>If this is the case, then you may need to shut down your MID Server, and check these two property files for what version they are reporting. If you are seeing a mismatch in these two files compared with what is being reported as the version of your MID Server,   you will need to match the files up accordingly.</p><p></p><p>I would suggest</p><ol><li>Match the MID servers to the older version value</li><li>Restart your MID server to identify itself as an older version</li><li>Run the upgrade process to upgrade the MID server to the desired version</li></ol></td></tr></tbody></table><p></p><h4 style="margin-bottom: .0001pt; background: white;">Mismatching core file</h4><p>If the mismatch is in the "core" file, then updating this to the correct name shouldn't be too difficult, as this will be based on the version of the MID Server that you are seeing. The naming convention will be "mid-core.[version].universal.universal.zip".</p><p></p><p>Here is an example of the naming convention:</p><p><span style="font-size: 10pt; font-family: 'Courier New';">package.filename=mid-core.2016-02-23-1231.universal.universal.zip</span></p><p><span style="font-size: 10pt; font-family: 'Courier New';">package.filename=mid-core.geneva-08-25-2015__patch3-hotfix2-02-04-2016_02-04-2016_1909.universal.universal.zip</span></p><p></p><h4>Mismatching jre file</h4><p>However, if this mismatch is in the "jre" file, it can be a little more complicated. In the case of a mismatching jre file, you either want to check another MID Server, which may still be on the previous version that you can reference against, or download a new MID Server agent file that you can reference also, if available.</p><p></p><h1>"incoming" upgrade files and the ServiceNow Platform Distribution Upgrade service</h1><p>Incoming upgrade files and platform distribution upgrade actually coincides with the previous issues I mentioned. If one of these issues occur and causes the upgrade process to fail during the middle of upgrading, this can leave some extraneous files and services on your MID Server host. The extraneous files could then prevent you from being able to subsequently upgrade these MID Servers.</p><p></p><h4>Check the agent folder</h4><p>The first area to check is on the agent folder, under the location "agent\package\incoming." Check here and see if there are any files currently located in this folder.</p><p><img   alt="platform distribution upgrade.jpg" class="image-9 jive-image" src="20e88502db90d304b322f4621f961927.iix" style="width: 620px; height: 90px; display: block; margin-left: auto; margin-right: auto;"/></p><p></p><p>If you are seeing these files here and you are having an upgrade issue, Make sure the MID server service is not running and remove the files. This will eventually allow you to re-download the appropriate files in case there may have been some issue during the previous upgrade process.</p><p></p><h4>Check the Services console on your MID Server host</h4><p>The second area to check is the Services console on your MID Server host. You may see a stalled "ServiceNow Platform Distribution Upgrade" Service running (or at least existing) in this console.</p><p></p><p>The Service Platform Distribution service runs to perform the Upgrade process. If your MID Server has an issue while upgrading, it can cause this process to be stalled or hung. If you try and proceed with another attempt at upgrading the process will not move forward due to the already existing and processing event.   Therefore, if you are seeing this issue on your MID Server, the best way to address it is to shut down the MID server service and delete this Service manually from a "cmd" window using the command <a title="echnet.microsoft.com/en-us/library/cc742045.aspx?f=255&MSPPError=-2147217396" href="https://technet.microsoft.com/en-us/library/cc742045.aspx?f=255&amp;MSPPError=-2147217396">"sc delete"</a>.</p><p></p><p>To find the Service name to delete, you will have to open the properties of the Upgrade Service.</p><p><img   alt="upgrade service name MID server.jpg" class="image-10 jive-image" src="1a07eccadbd05f048c8ef4621f9619a1.iix" style="height: auto; display: block; margin-left: auto; margin-right: auto;"/></p><p></p><p>In this case, the "ServiceName" is "snc-platform-dist-upgrade-geneva-mid."</p><p></p><p>Once you are then able to remove the failed incoming files and upgrade service references accordingly, then the upgrade process should be able to start from the beginning to re-download the files and run a new Upgrade service.</p><p></p><p>-</p><p></p><p>Now, these are certainly not all the ways that MID Server upgrade issues can occur, as there are numerous scenarios and setups and configurations that can cause a variety of errors and issues, but these are some of the most common issues, particularly with this Geneva upgrade, of where this issue can occur. If you find any other Geneva MID Server upgrade issues that you come across (and maybe even have a fix for), or if perhaps these suggestions don't seem to help with your particular issue, please feel free to comment on here and let us know.</p>